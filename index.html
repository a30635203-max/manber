<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>منبر المعرفة - نظام المستويات المتقدم</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* (الأنماط السابقة تبقى كما هي، ونضيف أنماطاً للأقسام) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #c9a959;
            --primary-dark: #b8943f;
            --bg-dark: #0a0c14;
            --bg-card: rgba(26, 31, 46, 0.95);
            --border: rgba(201, 169, 89, 0.3);
            --text-light: #fff;
            --text-gray: #888;
            --success: #00c853;
            --warning: #ffc107;
            --danger: #ff4444;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(145deg, var(--bg-dark) 0%, #1a1f2e 100%);
            color: var(--text-light);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }

        @media (max-width: 360px) {
            html {
                font-size: 14px;
            }
            .container {
                padding: 5px;
            }
        }

        header {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        @media (min-width: 768px) {
            header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 20px 30px;
            }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(145deg, var(--primary), var(--primary-dark));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--bg-dark);
            transform: rotate(5deg);
            box-shadow: 0 5px 15px rgba(201, 169, 89, 0.3);
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .logo-icon {
                width: 60px;
                height: 60px;
                font-size: 30px;
            }
        }

        .logo-text h1 {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #fff 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @media (min-width: 768px) {
            .logo-text h1 {
                font-size: 28px;
            }
        }

        .logo-text p {
            color: var(--text-gray);
            font-size: 12px;
        }

        @media (min-width: 768px) {
            .logo-text p {
                font-size: 14px;
            }
        }

        .global-progress {
            background: rgba(201, 169, 89, 0.15);
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 12px 15px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        @media (min-width: 768px) {
            .global-progress {
                padding: 15px 25px;
                flex-wrap: nowrap;
                gap: 30px;
            }
        }

        .global-stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .global-stat i {
            color: var(--primary);
            font-size: 20px;
        }

        .global-stat-info {
            text-align: center;
        }

        .global-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        @media (min-width: 768px) {
            .global-stat-value {
                font-size: 24px;
            }
        }

        .global-stat-label {
            font-size: 10px;
            color: var(--text-gray);
        }

        @media (min-width: 768px) {
            .global-stat-label {
                font-size: 12px;
            }
        }

        .global-progress-bar {
            width: 100%;
            max-width: 200px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            .global-progress-bar {
                width: 200px;
            }
        }

        .global-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            width: 0%;
            transition: width 0.3s;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .main-categories-screen {
            text-align: center;
            padding: 20px 10px;
        }

        @media (min-width: 768px) {
            .main-categories-screen {
                padding: 40px 20px;
            }
        }

        .screen-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @media (min-width: 768px) {
            .screen-title {
                font-size: 36px;
                margin-bottom: 20px;
            }
        }

        .screen-subtitle {
            color: var(--text-gray);
            font-size: 14px;
            margin-bottom: 30px;
        }

        @media (min-width: 768px) {
            .screen-subtitle {
                font-size: 18px;
                margin-bottom: 50px;
            }
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }

        @media (min-width: 768px) {
            .categories-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 25px;
            }
        }

        .category-card {
            background: var(--bg-card);
            border: 1px solid rgba(201, 169, 89, 0.2);
            border-radius: 15px;
            padding: 20px 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        @media (min-width: 768px) {
            .category-card {
                padding: 30px 20px;
                border-radius: 25px;
            }
        }

        .category-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 20px 40px rgba(201, 169, 89, 0.2);
        }

        .category-card.selected {
            border: 2px solid var(--primary);
            background: linear-gradient(145deg, rgba(201, 169, 89, 0.1), rgba(201, 169, 89, 0.05));
        }

        .category-icon {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 10px;
        }

        @media (min-width: 768px) {
            .category-icon {
                font-size: 50px;
                margin-bottom: 20px;
            }
        }

        .category-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        @media (min-width: 768px) {
            .category-name {
                font-size: 24px;
            }
        }

        .category-progress {
            display: flex;
            justify-content: center;
            gap: 10px;
            color: var(--text-gray);
            font-size: 12px;
        }

        @media (min-width: 768px) {
            .category-progress {
                font-size: 14px;
            }
        }

        .category-progress span {
            color: var(--primary);
            font-weight: 600;
        }

        .next-btn, .start-level-btn, .continue-btn {
            background: linear-gradient(145deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: 12px;
            padding: 15px 30px;
            color: var(--bg-dark);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
        }

        @media (min-width: 768px) {
            .next-btn, .start-level-btn, .continue-btn {
                padding: 18px 60px;
                font-size: 20px;
                border-radius: 15px;
                width: auto;
            }
        }

        .next-btn:hover, .start-level-btn:hover, .continue-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(201, 169, 89, 0.4);
        }

        .next-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 8px 15px;
            color: var(--primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        @media (min-width: 768px) {
            .back-btn {
                padding: 12px 30px;
                font-size: 16px;
                margin-bottom: 20px;
            }
        }

        .imams-screen {
            padding: 20px 10px;
        }

        @media (min-width: 768px) {
            .imams-screen {
                padding: 40px 20px;
            }
        }

        .imams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
            max-width: 1200px;
            margin: 20px auto;
        }

        @media (min-width: 768px) {
            .imams-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 20px;
                margin: 40px auto;
            }
        }

        .imam-card {
            background: var(--bg-card);
            border: 1px solid rgba(201, 169, 89, 0.2);
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        @media (min-width: 768px) {
            .imam-card {
                padding: 20px;
                border-radius: 20px;
            }
        }

        .imam-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
        }

        .imam-card.selected {
            border: 2px solid var(--primary);
        }

        .imam-icon {
            font-size: 28px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        @media (min-width: 768px) {
            .imam-icon {
                font-size: 40px;
                margin-bottom: 15px;
            }
        }

        .imam-name {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        @media (min-width: 768px) {
            .imam-name {
                font-size: 18px;
            }
        }

        .imam-progress {
            font-size: 11px;
            color: var(--text-gray);
        }

        .levels-screen {
            padding: 20px 10px;
        }

        @media (min-width: 768px) {
            .levels-screen {
                padding: 40px 20px;
            }
        }

        .levels-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .selected-info {
            display: inline-block;
            background: rgba(201, 169, 89, 0.15);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 8px 20px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .selected-info {
                padding: 10px 30px;
                font-size: 16px;
                margin-bottom: 20px;
            }
        }

        .levels-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            max-width: 800px;
            margin: 0 auto 30px;
        }

        @media (min-width: 640px) {
            .levels-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
        }

        .level-item {
            background: var(--bg-card);
            border: 1px solid rgba(201, 169, 89, 0.2);
            border-radius: 15px;
            padding: 20px;
            position: relative;
            transition: all 0.3s;
            cursor: pointer;
        }

        @media (min-width: 768px) {
            .level-item {
                padding: 25px;
            }
        }

        .level-item.unlocked:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
        }

        .level-item.locked {
            opacity: 0.6;
            filter: blur(0.5px);
            cursor: not-allowed;
        }

        .level-lock {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #ff4444;
            font-size: 16px;
        }

        .level-icon {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .level-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .level-stats {
            display: flex;
            justify-content: space-between;
            color: var(--text-gray);
            font-size: 12px;
            margin-bottom: 12px;
        }

        .level-progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .level-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            width: 0%;
            transition: width 0.3s;
        }

        /* شاشة الأقسام */
        .sections-screen {
            padding: 20px 10px;
        }

        .sections-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            max-width: 600px;
            margin: 30px auto;
        }

        @media (min-width: 640px) {
            .sections-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 25px;
            }
        }

        .section-card {
            background: var(--bg-card);
            border: 1px solid rgba(201, 169, 89, 0.2);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            position: relative;
            transition: all 0.3s;
        }

        .section-card.locked {
            opacity: 0.5;
            filter: blur(0.5px);
            cursor: not-allowed;
        }

        .section-card.completed {
            border: 2px solid var(--success);
        }

        .section-card.current {
            border: 2px solid var(--primary);
            background: linear-gradient(145deg, rgba(201, 169, 89, 0.1), rgba(201, 169, 89, 0.05));
            cursor: pointer;
        }

        .section-card.current:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(201, 169, 89, 0.2);
        }

        .section-icon {
            font-size: 40px;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .section-card.completed .section-icon {
            color: var(--success);
        }

        .section-name {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .section-desc {
            color: var(--text-gray);
            font-size: 14px;
            margin-bottom: 20px;
        }

        .section-status {
            display: flex;
            justify-content: center;
            gap: 15px;
            color: var(--text-gray);
            font-size: 13px;
            margin-bottom: 15px;
        }

        .section-status i {
            color: var(--primary);
        }

        .section-card.completed .section-status i {
            color: var(--success);
        }

        .section-lock {
            position: absolute;
            top: 15px;
            left: 15px;
            color: var(--danger);
            font-size: 20px;
        }

        .section-progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .section-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            width: 0%;
            transition: width 0.3s;
        }

        .section-card.completed .section-progress-fill {
            background: var(--success);
        }

        .test-screen {
            padding: 10px;
        }

        @media (min-width: 768px) {
            .test-screen {
                padding: 20px;
            }
        }

        .test-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(26, 31, 46, 0.5);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        @media (min-width: 640px) {
            .test-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 20px;
            }
        }

        .test-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .test-badge {
            background: rgba(201, 169, 89, 0.15);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 6px 15px;
            color: var(--primary);
            font-weight: 600;
            font-size: 12px;
        }

        @media (min-width: 768px) {
            .test-badge {
                padding: 8px 25px;
                font-size: 14px;
            }
        }

        .question-progress {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 6px 15px;
            font-size: 12px;
        }

        .question-container {
            background: var(--bg-card);
            border: 1px solid rgba(201, 169, 89, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .question-container {
                padding: 40px;
                border-radius: 20px;
                margin-bottom: 30px;
            }
        }

        .question-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        @media (min-width: 768px) {
            .question-text {
                font-size: 26px;
                margin-bottom: 40px;
            }
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        @media (min-width: 640px) {
            .options-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
        }

        .option {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(201, 169, 89, 0.15);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .option {
                padding: 20px 25px;
                font-size: 18px;
                border-radius: 15px;
            }
        }

        .option:hover {
            background: rgba(201, 169, 89, 0.1);
            border-color: var(--primary);
            transform: translateX(-5px);
        }

        .option.selected {
            background: linear-gradient(145deg, rgba(201, 169, 89, 0.2), rgba(201, 169, 89, 0.1));
            border-color: var(--primary);
            border-right-width: 4px;
        }

        .test-footer {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        @media (min-width: 640px) {
            .test-footer {
                flex-wrap: nowrap;
                justify-content: space-between;
            }
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 20px;
            color: var(--primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }

        .nav-btn:hover:not(:disabled) {
            background: rgba(201, 169, 89, 0.1);
            border-color: var(--primary);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .submit-btn {
            background: linear-gradient(145deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            color: var(--bg-dark);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            flex: 2;
            display: none; /* يظهر فقط في السؤال الأخير */
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(201, 169, 89, 0.3);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .result-screen {
            padding: 20px 10px;
        }

        @media (min-width: 768px) {
            .result-screen {
                padding: 40px 20px;
            }
        }

        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 30px 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        @media (min-width: 768px) {
            .result-card {
                padding: 50px;
                border-radius: 30px;
            }
        }

        .result-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, var(--primary), var(--primary-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 40px;
            color: var(--bg-dark);
        }

        @media (min-width: 768px) {
            .result-icon {
                width: 120px;
                height: 120px;
                font-size: 60px;
            }
        }

        .result-score {
            font-size: 48px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .result-message {
            font-size: 20px;
            margin-bottom: 20px;
        }

        .next-level-info {
            background: rgba(201, 169, 89, 0.1);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            font-size: 14px;
        }

        .loading-screen {
            text-align: center;
            padding: 50px 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(201, 169, 89, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 12px 20px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 14px;
            z-index: 1000;
            animation: slideDown 0.3s ease;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        @keyframes slideDown {
            from { transform: translate(-50%, -100%); }
            to { transform: translate(-50%, 0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-mosque"></i>
                </div>
                <div class="logo-text">
                    <h1>منبر المعرفة</h1>
                    <p>نظام المستويات المتقدم</p>
                </div>
            </div>
            <div class="global-progress">
                <div class="global-stat">
                    <i class="fas fa-star"></i>
                    <div class="global-stat-info">
                        <div class="global-stat-value" id="totalCorrect">0</div>
                        <div class="global-stat-label">صحيحة</div>
                    </div>
                </div>
                <div class="global-stat">
                    <i class="fas fa-check-circle"></i>
                    <div class="global-stat-info">
                        <div class="global-stat-value" id="totalAnswered">0</div>
                        <div class="global-stat-label">تمت</div>
                    </div>
                </div>
                <div class="global-progress-bar">
                    <div class="global-progress-fill" id="globalProgressFill"></div>
                </div>
            </div>
        </header>

        <!-- شاشة التحميل -->
        <div class="loading-screen screen active" id="loadingScreen">
            <div class="spinner"></div>
            <p>جاري تحميل الأسئلة...</p>
        </div>

        <!-- واجهة اختيار التصنيفات الرئيسية -->
        <div class="main-categories-screen screen" id="mainCategoriesScreen">
            <h2 class="screen-title">اختر نوع الأسئلة</h2>
            <p class="screen-subtitle">اختر التصنيف الذي تريد الاختبار فيه</p>
            <div class="categories-grid" id="mainCategoriesGrid">
                <div class="category-card" onclick="selectMainCategory('general')">
                    <div class="category-icon"><i class="fas fa-globe"></i></div>
                    <div class="category-name">أسئلة عامة</div>
                    <div class="category-progress">
                        <span id="general-progress">0</span> / 400
                    </div>
                </div>
                <div class="category-card" onclick="selectMainCategory('prophet')">
                    <div class="category-icon"><i class="fas fa-star"></i></div>
                    <div class="category-name">النبي (ص)</div>
                    <div class="category-progress">
                        <span id="prophet-progress">0</span> / 400
                    </div>
                </div>
                <div class="category-card" onclick="selectMainCategory('ahlulbayt')">
                    <div class="category-icon"><i class="fas fa-users"></i></div>
                    <div class="category-name">أهل البيت</div>
                    <div class="category-progress">
                        <span id="ahlulbayt-progress">0</span> / 5600
                    </div>
                </div>
                <div class="category-card" onclick="selectMainCategory('fiqh')">
                    <div class="category-icon"><i class="fas fa-book"></i></div>
                    <div class="category-name">أسئلة فقهية</div>
                    <div class="category-progress">
                        <span id="fiqh-progress">0</span> / 400
                    </div>
                </div>
                <div class="category-card" onclick="selectMainCategory('language')">
                    <div class="category-icon"><i class="fas fa-language"></i></div>
                    <div class="category-name">أسئلة لغوية</div>
                    <div class="category-progress">
                        <span id="language-progress">0</span> / 400
                    </div>
                </div>
            </div>
            <div style="text-align: center;">
                <button class="next-btn" onclick="goToNextScreen()" id="nextFromMainBtn" disabled>
                    <span>التالي</span>
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>

        <!-- واجهة اختيار الأئمة -->
        <div class="imams-screen screen" id="imamsScreen">
            <button class="back-btn" onclick="showScreen('mainCategoriesScreen')">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            <h2 class="screen-title">اختر الإمام</h2>
            <p class="screen-subtitle">اختر إماماً معيناً أو الأسئلة الشاملة</p>
            <div class="imams-grid" id="imamsGrid"></div>
            <div style="text-align: center;">
                <button class="next-btn" onclick="goToLevelsFromImams()" id="nextFromImamsBtn" disabled>
                    <span>التالي للمستويات</span>
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>

        <!-- واجهة المستويات -->
        <div class="levels-screen screen" id="levelsScreen">
            <button class="back-btn" onclick="goBackFromLevels()" id="backFromLevelsBtn">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            <div class="levels-header">
                <div class="selected-info" id="selectedInfo">
                    <i class="fas fa-tag"></i>
                    <span>اختر تصنيفاً أولاً</span>
                </div>
                <h2 class="screen-title">اختر المستوى</h2>
                <p class="screen-subtitle">كل مستوى 100 سؤال - تحتاج 75% لفتح التالي</p>
            </div>
            <div class="levels-grid" id="levelsGrid"></div>
            <div style="text-align: center;">
                <button class="start-level-btn" onclick="goToSections()" id="startLevelBtn" disabled>
                    <span>عرض الأقسام</span>
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>

        <!-- واجهة الأقسام -->
        <div class="sections-screen screen" id="sectionsScreen">
            <button class="back-btn" onclick="showScreen('levelsScreen')">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            <div class="levels-header">
                <div class="selected-info" id="sectionsInfo">
                    <i class="fas fa-layer-group"></i>
                    <span>المستوى السهل</span>
                </div>
                <h2 class="screen-title">اختر القسم</h2>
                <p class="screen-subtitle">كل قسم 25 سؤال - أكمل القسم لتفتح التالي</p>
            </div>
            <div class="sections-grid" id="sectionsGrid"></div>
            <div style="text-align: center;" id="startSectionBtnContainer" style="display: none;">
                <button class="start-level-btn" onclick="startSelectedSection()" id="startSectionBtn">
                    <span>ابدأ الاختبار</span>
                    <i class="fas fa-play"></i>
                </button>
            </div>
        </div>

        <!-- واجهة الاختبار -->
        <div class="test-screen screen" id="testScreen">
            <button class="back-btn" onclick="confirmExit()">
                <i class="fas fa-arrow-right"></i> خروج
            </button>
            <div class="test-header">
                <div class="test-info">
                    <div class="test-badge" id="testCategory">-</div>
                    <div class="test-badge" id="testSubCategory"></div>
                    <div class="test-badge" id="testLevel">-</div>
                    <div class="test-badge" id="testSection">-</div>
                    <div class="question-progress">
                        <span id="currentQuestion">1</span> / <span id="totalQuestions">25</span>
                    </div>
                </div>
            </div>
            <div class="question-container" id="questionContainer"></div>
            <div class="test-footer">
                <button class="nav-btn" onclick="previousQuestion()" id="prevBtn" disabled>
                    <i class="fas fa-arrow-right"></i> السابق
                </button>
                <button class="nav-btn" onclick="nextQuestion()" id="nextBtn" disabled>
                    التالي <i class="fas fa-arrow-left"></i>
                </button>
                <button class="submit-btn" onclick="submitSection()" id="submitBtn" disabled>
                    <i class="fas fa-check-circle"></i> تسليم القسم
                </button>
            </div>
        </div>

        <!-- واجهة النتيجة -->
        <div class="result-screen screen" id="resultScreen">
            <div class="result-card">
                <div class="result-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="result-score" id="finalScore">0/25</div>
                <div class="result-message" id="resultMessage"></div>
                <div class="next-level-info" id="nextLevelInfo"></div>
                <button class="continue-btn" onclick="continueToSections()">
                    <i class="fas fa-redo-alt"></i> العودة للأقسام
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== مسارات ملفات الأسئلة (كما هي) ====================
        const questionPaths = {
            general: { base: 'questions/general/', files: ['general_easy.js', 'general_medium.js', 'general_hard.js', 'general_expert.js'] },
            prophet: { base: 'questions/prophet/', files: ['prophet_easy.js', 'prophet_medium.js', 'prophet_hard.js', 'prophet_expert.js'] },
            fiqh: { base: 'questions/fiqh/', files: ['fiqh_easy.js', 'fiqh_medium.js', 'fiqh_hard.js', 'fiqh_expert.js'] },
            language: { base: 'questions/language/', files: ['language_easy.js', 'language_medium.js', 'language_hard.js', 'language_expert.js'] },
            ali: { base: 'questions/ahlulbayt/ali/', files: ['ali_easy.js', 'ali_medium.js', 'ali_hard.js', 'ali_expert.js'] },
            fatima: { base: 'questions/ahlulbayt/fatima/', files: ['fatima_easy.js', 'fatima_medium.js', 'fatima_hard.js', 'fatima_expert.js'] },
            hasan: { base: 'questions/ahlulbayt/hasan/', files: ['hasan_easy.js', 'hasan_medium.js', 'hasan_hard.js', 'hasan_expert.js'] },
            hussein: { base: 'questions/ahlulbayt/hussein/', files: ['hussein_easy.js', 'hussein_medium.js', 'hussein_hard.js', 'hussein_expert.js'] },
            sajjad: { base: 'questions/ahlulbayt/sajjad/', files: ['sajjad_easy.js', 'sajjad_medium.js', 'sajjad_hard.js', 'sajjad_expert.js'] },
            baqir: { base: 'questions/ahlulbayt/baqir/', files: ['baqir_easy.js', 'baqir_medium.js', 'baqir_hard.js', 'baqir_expert.js'] },
            sadiq: { base: 'questions/ahlulbayt/sadiq/', files: ['sadiq_easy.js', 'sadiq_medium.js', 'sadiq_hard.js', 'sadiq_expert.js'] },
            kadhim: { base: 'questions/ahlulbayt/kadhim/', files: ['kadhim_easy.js', 'kadhim_medium.js', 'kadhim_hard.js', 'kadhim_expert.js'] },
            reza: { base: 'questions/ahlulbayt/reza/', files: ['reza_easy.js', 'reza_medium.js', 'reza_hard.js', 'reza_expert.js'] },
            jawad: { base: 'questions/ahlulbayt/jawad/', files: ['jawad_easy.js', 'jawad_medium.js', 'jawad_hard.js', 'jawad_expert.js'] },
            hadi: { base: 'questions/ahlulbayt/hadi/', files: ['hadi_easy.js', 'hadi_medium.js', 'hadi_hard.js', 'hadi_expert.js'] },
            askari: { base: 'questions/ahlulbayt/askari/', files: ['askari_easy.js', 'askari_medium.js', 'askari_hard.js', 'askari_expert.js'] },
            mahdi: { base: 'questions/ahlulbayt/mahdi/', files: ['mahdi_easy.js', 'mahdi_medium.js', 'mahdi_hard.js', 'mahdi_expert.js'] },
            comprehensive: { base: 'questions/ahlulbayt/comprehensive/', files: ['comprehensive_easy.js', 'comprehensive_medium.js', 'comprehensive_hard.js', 'comprehensive_expert.js'] }
        };

        // ==================== بيانات التقدم (هيكل جديد مع الأقسام) ====================
        let defaultProgress = {
            general: { currentLevel: 1, levels: {} },
            prophet: { currentLevel: 1, levels: {} },
            fiqh: { currentLevel: 1, levels: {} },
            language: { currentLevel: 1, levels: {} },
            ali: { currentLevel: 1, levels: {} },
            fatima: { currentLevel: 1, levels: {} },
            hasan: { currentLevel: 1, levels: {} },
            hussein: { currentLevel: 1, levels: {} },
            sajjad: { currentLevel: 1, levels: {} },
            baqir: { currentLevel: 1, levels: {} },
            sadiq: { currentLevel: 1, levels: {} },
            kadhim: { currentLevel: 1, levels: {} },
            reza: { currentLevel: 1, levels: {} },
            jawad: { currentLevel: 1, levels: {} },
            hadi: { currentLevel: 1, levels: {} },
            askari: { currentLevel: 1, levels: {} },
            mahdi: { currentLevel: 1, levels: {} },
            comprehensive: { currentLevel: 1, levels: {} }
        };

        // تهيئة المستويات لكل فئة
        for (let cat in defaultProgress) {
            for (let lvl = 1; lvl <= 4; lvl++) {
                defaultProgress[cat].levels[lvl] = {
                    currentSection: 1,
                    sections: {
                        1: { answers: {}, completed: false },
                        2: { answers: {}, completed: false },
                        3: { answers: {}, completed: false },
                        4: { answers: {}, completed: false }
                    }
                };
            }
        }

        // محاولة قراءة التقدم المخزن، وتحويله إذا كان بالهيكل القديم
        let stored = localStorage.getItem('userProgress');
        let userProgress;
        if (stored) {
            try {
                let parsed = JSON.parse(stored);
                // التحقق مما إذا كان بالهيكل القديم (يحتوي على answers)
                if (parsed.general && parsed.general.answers) {
                    // تحويل من القديم إلى الجديد
                    userProgress = JSON.parse(JSON.stringify(defaultProgress)); // نسخة عميقة من default
                    for (let cat in userProgress) {
                        if (parsed[cat]) {
                            userProgress[cat].currentLevel = parsed[cat].currentLevel || 1;
                            // تحويل الإجابات: لكل مستوى، نوزع الإجابات على الأقسام
                            for (let lvl = 1; lvl <= 4; lvl++) {
                                if (parsed[cat].answers && parsed[cat].answers[lvl]) {
                                    let oldAnswers = parsed[cat].answers[lvl];
                                    // نفرض أن الأسئلة 100، نقسمها 25 لكل قسم
                                    let sectionAnswers = {1: {}, 2: {}, 3: {}, 4: {}};
                                    for (let qIdx in oldAnswers) {
                                        let qNum = parseInt(qIdx);
                                        let section = Math.floor(qNum / 25) + 1; // 0-24 -> قسم1, 25-49 -> قسم2, ...
                                        if (section > 4) section = 4;
                                        let localIdx = qNum % 25;
                                        sectionAnswers[section][localIdx] = oldAnswers[qIdx];
                                    }
                                    // تحديث كل قسم
                                    for (let s = 1; s <= 4; s++) {
                                        userProgress[cat].levels[lvl].sections[s].answers = sectionAnswers[s];
                                        // تحديد ما إذا كان القسم مكتملاً (25 إجابة)
                                        let ansCount = Object.keys(sectionAnswers[s]).length;
                                        userProgress[cat].levels[lvl].sections[s].completed = (ansCount === 25);
                                    }
                                    // تحديد currentSection: أول قسم غير مكتمل
                                    let curSec = 1;
                                    while (curSec <= 4 && userProgress[cat].levels[lvl].sections[curSec].completed) curSec++;
                                    userProgress[cat].levels[lvl].currentSection = curSec <= 4 ? curSec : 1;
                                }
                            }
                        }
                    }
                } else {
                    userProgress = parsed;
                }
            } catch (e) {
                userProgress = JSON.parse(JSON.stringify(defaultProgress));
            }
        } else {
            userProgress = JSON.parse(JSON.stringify(defaultProgress));
        }

        // ==================== قاعدة بيانات الأسئلة ====================
        let questionsDatabase = {};

        // ==================== متغيرات الحالة ====================
        let selectedMainCategory = null;
        let selectedImam = null;
        let selectedCategory = null;
        let selectedLevel = 1;
        let selectedSection = 1;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let currentAnswers = {};

        const levelNames = ['', 'سهل', 'متوسط', 'صعب', 'خبير'];
        const sectionNames = ['الأول', 'الثاني', 'الثالث', 'الرابع'];
        const sectionIcons = ['fa-1', 'fa-2', 'fa-3', 'fa-4'];
        
        const categoryNames = {
            general: 'أسئلة عامة',
            prophet: 'النبي (ص)',
            fiqh: 'أسئلة فقهية',
            language: 'أسئلة لغوية',
            ali: 'الإمام علي (ع)',
            fatima: 'السيدة فاطمة (ع)',
            hasan: 'الإمام الحسن (ع)',
            hussein: 'الإمام الحسين (ع)',
            sajjad: 'الإمام السجاد (ع)',
            baqir: 'الإمام الباقر (ع)',
            sadiq: 'الإمام الصادق (ع)',
            kadhim: 'الإمام الكاظم (ع)',
            reza: 'الإمام الرضا (ع)',
            jawad: 'الإمام الجواد (ع)',
            hadi: 'الإمام الهادي (ع)',
            askari: 'الإمام العسكري (ع)',
            mahdi: 'الإمام المهدي (ع)',
            comprehensive: 'أسئلة شاملة'
        };

        // ==================== إنشاء شبكة الأئمة ====================
        function renderImamsGrid() {
            const grid = document.getElementById('imamsGrid');
            const imams = [
                { id: 'ali', name: 'الإمام علي (ع)', icon: 'fa-user-tie' },
                { id: 'fatima', name: 'السيدة فاطمة (ع)', icon: 'fa-female' },
                { id: 'hasan', name: 'الإمام الحسن (ع)', icon: 'fa-user-tie' },
                { id: 'hussein', name: 'الإمام الحسين (ع)', icon: 'fa-user-tie' },
                { id: 'sajjad', name: 'الإمام السجاد (ع)', icon: 'fa-user-tie' },
                { id: 'baqir', name: 'الإمام الباقر (ع)', icon: 'fa-user-tie' },
                { id: 'sadiq', name: 'الإمام الصادق (ع)', icon: 'fa-user-tie' },
                { id: 'kadhim', name: 'الإمام الكاظم (ع)', icon: 'fa-user-tie' },
                { id: 'reza', name: 'الإمام الرضا (ع)', icon: 'fa-user-tie' },
                { id: 'jawad', name: 'الإمام الجواد (ع)', icon: 'fa-user-tie' },
                { id: 'hadi', name: 'الإمام الهادي (ع)', icon: 'fa-user-tie' },
                { id: 'askari', name: 'الإمام العسكري (ع)', icon: 'fa-user-tie' },
                { id: 'mahdi', name: 'الإمام المهدي (ع)', icon: 'fa-user-tie' },
                { id: 'comprehensive', name: 'أسئلة شاملة', icon: 'fa-users' }
            ];

            imams.forEach(imam => {
                const progress = userProgress[imam.id];
                let answered = 0;
                for (let lvl = 1; lvl <= 4; lvl++) {
                    for (let s = 1; s <= 4; s++) {
                        answered += Object.keys(progress.levels[lvl]?.sections[s]?.answers || {}).length;
                    }
                }
                const card = document.createElement('div');
                card.className = 'imam-card';
                card.onclick = () => selectImam(imam.id);
                card.innerHTML = `
                    <div class="imam-icon"><i class="fas ${imam.icon}"></i></div>
                    <div class="imam-name">${imam.name}</div>
                    <div class="imam-progress">${answered}/400</div>
                `;
                grid.appendChild(card);
            });
        }

        // ==================== تحميل الأسئلة ====================
        async function loadAllQuestions() {
            showScreen('loadingScreen');
            const allCategories = Object.keys(questionPaths);
            for (let category of allCategories) {
                const path = questionPaths[category];
                questionsDatabase[category] = {};
                for (let level = 1; level <= 4; level++) {
                    const fileName = path.files[level - 1];
                    const fullPath = path.base + fileName;
                    try {
                        await loadScript(fullPath, category, level);
                    } catch (error) {
                        console.log(`❌ الملف غير موجود: ${fullPath}`);
                    }
                }
            }
            updateAllProgress();
            setTimeout(() => showScreen('mainCategoriesScreen'), 1000);
        }

        function loadScript(path, category, level) {
            return new Promise((resolve) => {
                const script = document.createElement('script');
                script.src = path;
                script.onload = () => {
                    console.log(`✅ تم تحميل الملف: ${path}`);
                    setTimeout(() => {
                        let questionsArray = null;
                        const expectedName = `questions_${category}_${level}`;
                        if (window[expectedName]) {
                            questionsArray = window[expectedName];
                        } else {
                            const allVars = Object.keys(window);
                            const pattern = new RegExp(`${category}.*${level}`, 'i');
                            const found = allVars.find(v => pattern.test(v) && Array.isArray(window[v]) && window[v].length > 0);
                            if (found) questionsArray = window[found];
                        }
                        if (!questionsArray) {
                            for (let v of Object.keys(window)) {
                                if (Array.isArray(window[v]) && window[v].length > 0 && window[v][0]?.question) {
                                    questionsArray = window[v];
                                    break;
                                }
                            }
                        }
                        if (questionsArray) {
                            if (!questionsDatabase[category]) questionsDatabase[category] = {};
                            questionsDatabase[category][level] = questionsArray;
                            console.log(`   ✅ تم تخزين ${questionsArray.length} سؤال للفئة ${category} المستوى ${level}`);
                        }
                        resolve();
                    }, 100);
                };
                script.onerror = () => {
                    console.warn(`❌ فشل تحميل الملف: ${path}`);
                    resolve();
                };
                document.head.appendChild(script);
            });
        }

        // ==================== دوال التحديث ====================
        function updateAllProgress() {
            updateCategoryProgress('general');
            updateCategoryProgress('prophet');
            updateCategoryProgress('fiqh');
            updateCategoryProgress('language');

            const imams = ['ali', 'fatima', 'hasan', 'hussein', 'sajjad', 'baqir', 'sadiq', 
                          'kadhim', 'reza', 'jawad', 'hadi', 'askari', 'mahdi', 'comprehensive'];
            let ahlulbaytTotal = 0;
            imams.forEach(imam => {
                const progress = userProgress[imam];
                let answered = 0;
                for (let lvl = 1; lvl <= 4; lvl++) {
                    for (let s = 1; s <= 4; s++) {
                        answered += Object.keys(progress.levels[lvl]?.sections[s]?.answers || {}).length;
                    }
                }
                ahlulbaytTotal += answered;
                const imamCard = document.querySelector(`.imam-card[onclick*="${imam}"] .imam-progress`);
                if (imamCard) imamCard.textContent = `${answered}/400`;
            });
            document.getElementById('ahlulbayt-progress').textContent = ahlulbaytTotal;
            updateGlobalProgress();
        }

        function updateCategoryProgress(category) {
            const progress = userProgress[category];
            let answered = 0;
            for (let lvl = 1; lvl <= 4; lvl++) {
                for (let s = 1; s <= 4; s++) {
                    answered += Object.keys(progress.levels[lvl]?.sections[s]?.answers || {}).length;
                }
            }
            document.getElementById(`${category}-progress`).textContent = answered;
        }

        function updateGlobalProgress() {
            let totalCorrect = 0, totalAnswered = 0, totalQuestions = 0;
            for (let category in userProgress) {
                for (let lvl = 1; lvl <= 4; lvl++) {
                    totalQuestions += 100;
                    for (let s = 1; s <= 4; s++) {
                        const answers = userProgress[category].levels[lvl]?.sections[s]?.answers || {};
                        totalAnswered += Object.keys(answers).length;
                        Object.values(answers).forEach(isCorrect => { if (isCorrect) totalCorrect++; });
                    }
                }
            }
            document.getElementById('totalCorrect').textContent = totalCorrect;
            document.getElementById('totalAnswered').textContent = totalAnswered;
            document.getElementById('globalProgressFill').style.width = `${(totalAnswered / totalQuestions) * 100}%`;
        }

        // ==================== دوال التنقل ====================
        function selectMainCategory(category) {
            selectedMainCategory = category;
            selectedImam = null;
            document.querySelectorAll('.category-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            document.getElementById('nextFromMainBtn').disabled = false;
        }

        function selectImam(imam) {
            selectedImam = imam;
            selectedMainCategory = 'ahlulbayt';
            document.querySelectorAll('.imam-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            document.getElementById('nextFromImamsBtn').disabled = false;
        }

        function goToNextScreen() {
            if (selectedMainCategory === 'ahlulbayt') {
                showScreen('imamsScreen');
            } else {
                selectedCategory = selectedMainCategory;
                renderLevels();
                showScreen('levelsScreen');
            }
        }

        function goToLevelsFromImams() {
            selectedCategory = selectedImam;
            renderLevels();
            showScreen('levelsScreen');
        }

        function goBackFromLevels() {
            if (selectedMainCategory === 'ahlulbayt' && selectedImam) {
                showScreen('imamsScreen');
            } else {
                showScreen('mainCategoriesScreen');
            }
        }

        function renderLevels() {
            const progress = userProgress[selectedCategory];
            const grid = document.getElementById('levelsGrid');
            grid.innerHTML = '';
            document.getElementById('selectedInfo').innerHTML = `<i class="fas fa-tag"></i><span>${categoryNames[selectedCategory] || selectedCategory}</span>`;
            const icons = ['fa-seedling', 'fa-tree', 'fa-mountain', 'fa-crown'];

            for (let level = 1; level <= 4; level++) {
                let answeredInLevel = 0;
                for (let s = 1; s <= 4; s++) {
                    answeredInLevel += Object.keys(progress.levels[level]?.sections[s]?.answers || {}).length;
                }
                const percentage = (answeredInLevel / 100) * 100;
                const isLocked = level > progress.currentLevel;

                const levelCard = document.createElement('div');
                levelCard.className = `level-item ${isLocked ? 'locked' : 'unlocked'}`;
                if (!isLocked) {
                    levelCard.onclick = () => selectLevel(level);
                }

                levelCard.innerHTML = `
                    ${isLocked ? '<div class="level-lock"><i class="fas fa-lock"></i></div>' : ''}
                    <div class="level-icon"><i class="fas ${icons[level-1]}"></i></div>
                    <div class="level-name">مستوى ${levelNames[level]}</div>
                    <div class="level-stats">
                        <span>${answeredInLevel}/100</span>
                        <span>${percentage.toFixed(0)}%</span>
                    </div>
                    <div class="level-progress-bar">
                        <div class="level-progress-fill" style="width: ${percentage}%"></div>
                    </div>
                `;
                grid.appendChild(levelCard);
            }
            document.getElementById('startLevelBtn').disabled = true;
        }

        function selectLevel(level) {
            selectedLevel = level;
            document.querySelectorAll('.level-item').forEach(i => i.style.border = 'none');
            event.currentTarget.style.border = '2px solid #c9a959';
            document.getElementById('startLevelBtn').disabled = false;
        }

        function goToSections() {
            renderSections();
            showScreen('sectionsScreen');
        }

        function renderSections() {
            const progress = userProgress[selectedCategory];
            const levelData = progress.levels[selectedLevel];
            const grid = document.getElementById('sectionsGrid');
            grid.innerHTML = '';
            document.getElementById('sectionsInfo').innerHTML = `<i class="fas fa-layer-group"></i><span>${categoryNames[selectedCategory]} - مستوى ${levelNames[selectedLevel]}</span>`;

            for (let section = 1; section <= 4; section++) {
                const answers = levelData.sections[section].answers;
                const answeredCount = Object.keys(answers).length;
                const isCompleted = levelData.sections[section].completed;
                const isCurrent = (section === levelData.currentSection) && !isCompleted;
                const isLocked = section > levelData.currentSection;

                const sectionCard = document.createElement('div');
                sectionCard.className = `section-card ${isLocked ? 'locked' : ''} ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}`;
                if (isCurrent) {
                    sectionCard.onclick = () => selectSection(section);
                }

                sectionCard.innerHTML = `
                    ${isLocked ? '<div class="section-lock"><i class="fas fa-lock"></i></div>' : ''}
                    <div class="section-icon"><i class="fas ${sectionIcons[section-1]}"></i></div>
                    <div class="section-name">القسم ${sectionNames[section-1]}</div>
                    <div class="section-desc">25 سؤال</div>
                    <div class="section-status">
                        <span><i class="fas fa-check-circle"></i> ${answeredCount}/25</span>
                    </div>
                    <div class="section-progress-bar">
                        <div class="section-progress-fill" style="width: ${(answeredCount/25)*100}%"></div>
                    </div>
                    ${isCompleted ? '<div class="section-status" style="color: var(--success);"><i class="fas fa-check-circle"></i> مكتمل</div>' : ''}
                `;
                grid.appendChild(sectionCard);
            }

            // إخفاء زر البدء حتى يتم اختيار قسم
            document.getElementById('startSectionBtnContainer').style.display = 'none';
        }

        function selectSection(section) {
            selectedSection = section;
            // إظهار زر البدء
            document.getElementById('startSectionBtnContainer').style.display = 'block';
        }

        function startSelectedSection() {
            startSection();
        }

        function startSection() {
            if (!questionsDatabase[selectedCategory] || !questionsDatabase[selectedCategory][selectedLevel]) {
                showAlert('❌ لم يتم تحميل الأسئلة');
                return;
            }

            const allQuestions = questionsDatabase[selectedCategory][selectedLevel];
            const startIndex = (selectedSection - 1) * 25;
            const endIndex = startIndex + 25;
            const sectionQuestions = allQuestions.slice(startIndex, endIndex);

            const progress = userProgress[selectedCategory].levels[selectedLevel];
            currentAnswers = progress.sections[selectedSection].answers || {};

            // تجهيز الأسئلة مع خلط الخيارات
            currentQuestions = sectionQuestions.map(q => {
                const optionsWithIndex = q.options.map((opt, idx) => ({ text: opt, originalIndex: idx }));
                const shuffledOptions = optionsWithIndex.sort(() => Math.random() - 0.5);
                return {
                    question: q.question,
                    options: shuffledOptions.map(opt => opt.text),
                    correct: shuffledOptions.findIndex(opt => opt.originalIndex === q.correct)
                };
            });

            // البحث عن أول سؤال غير مجاب عليه
            currentQuestionIndex = 0;
            for (let i = 0; i < currentQuestions.length; i++) {
                if (currentAnswers[i] === undefined) {
                    currentQuestionIndex = i;
                    break;
                }
            }

            document.getElementById('testCategory').textContent = selectedMainCategory === 'ahlulbayt' ? 'أهل البيت' : categoryNames[selectedCategory];
            document.getElementById('testSubCategory').textContent = (selectedMainCategory === 'ahlulbayt' && selectedImam) ? categoryNames[selectedImam] : '';
            document.getElementById('testLevel').textContent = `مستوى ${levelNames[selectedLevel]}`;
            document.getElementById('testSection').textContent = `القسم ${selectedSection}`;
            document.getElementById('totalQuestions').textContent = currentQuestions.length;

            showScreen('testScreen');
            displayQuestion();
        }

        function displayQuestion() {
            const question = currentQuestions[currentQuestionIndex];
            let optionsHtml = '';
            question.options.forEach((option, index) => {
                const selectedClass = currentAnswers[currentQuestionIndex] === index ? 'selected' : '';
                optionsHtml += `<div class="option ${selectedClass}" onclick="selectOption(${index})">${option}</div>`;
            });
            document.getElementById('questionContainer').innerHTML = `
                <div class="question-text">${question.question}</div>
                <div class="options-grid">${optionsHtml}</div>
            `;
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;

            const hasAnswer = currentAnswers[currentQuestionIndex] !== undefined;
            document.getElementById('nextBtn').disabled = !hasAnswer;

            const isLastQuestion = currentQuestionIndex === currentQuestions.length - 1;
            document.getElementById('submitBtn').style.display = isLastQuestion ? 'inline-flex' : 'none';
            document.getElementById('nextBtn').style.display = isLastQuestion ? 'none' : 'inline-flex';

            if (isLastQuestion) {
                const allAnswered = currentQuestions.every((_, idx) => currentAnswers[idx] !== undefined);
                document.getElementById('submitBtn').disabled = !allAnswered;
            }
        }

        function selectOption(index) {
            currentAnswers[currentQuestionIndex] = index;
            // حفظ فوري
            userProgress[selectedCategory].levels[selectedLevel].sections[selectedSection].answers = currentAnswers;
            localStorage.setItem('userProgress', JSON.stringify(userProgress));
            displayQuestion();
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            }
        }

        function submitSection() {
            let correctCount = 0, answeredCount = 0;
            currentQuestions.forEach((q, idx) => {
                if (currentAnswers[idx] !== undefined) {
                    answeredCount++;
                    if (currentAnswers[idx] === q.correct) correctCount++;
                }
            });

            // تحديث حالة القسم
            const levelData = userProgress[selectedCategory].levels[selectedLevel];
            levelData.sections[selectedSection].completed = (answeredCount === 25);
            // إذا اكتمل، حدّث currentSection إلى التالي
            if (answeredCount === 25 && selectedSection < 4) {
                levelData.currentSection = selectedSection + 1;
            }
            localStorage.setItem('userProgress', JSON.stringify(userProgress));
            updateAllProgress();

            // عرض النتيجة
            showScreen('resultScreen');
            document.getElementById('finalScore').innerHTML = `${correctCount}<span style="font-size:24px;">/${answeredCount}</span>`;

            const percentage = (correctCount / (answeredCount || 1)) * 100;
            let message = '';
            if (percentage >= 90) message = '🏆 ممتاز!';
            else if (percentage >= 75) message = '🌟 أحسنت!';
            else if (percentage >= 50) message = '📚 جيد';
            else message = '💪 حاول مرة أخرى';
            document.getElementById('resultMessage').textContent = message;

            const nextInfo = document.getElementById('nextLevelInfo');
            if (selectedSection < 4 && answeredCount === 25) {
                nextInfo.innerHTML = `<i class="fas fa-unlock-alt"></i> تم فتح القسم التالي!`;
            } else if (selectedSection === 4 && answeredCount === 25 && selectedLevel < 4) {
                // حساب نسبة المستوى كامل
                let totalCorrectInLevel = 0, totalAnsweredInLevel = 0;
                for (let s = 1; s <= 4; s++) {
                    const ans = levelData.sections[s].answers;
                    totalAnsweredInLevel += Object.keys(ans).length;
                    Object.values(ans).forEach(v => { if (v) totalCorrectInLevel++; });
                }
                const levelPercentage = (totalCorrectInLevel / totalAnsweredInLevel) * 100;
                if (levelPercentage >= 75) {
                    userProgress[selectedCategory].currentLevel = selectedLevel + 1;
                    localStorage.setItem('userProgress', JSON.stringify(userProgress));
                    nextInfo.innerHTML = `<i class="fas fa-unlock-alt"></i> تهانينا! تم فتح المستوى ${levelNames[selectedLevel + 1]}`;
                } else {
                    nextInfo.innerHTML = `<i class="fas fa-lock"></i> تحتاج 75% في المستوى لفتح التالي`;
                }
            } else {
                nextInfo.innerHTML = `<i class="fas fa-info-circle"></i> أكمل القسم لتفتح التالي`;
            }
        }

        function continueToSections() {
            renderSections();
            showScreen('sectionsScreen');
        }

        function confirmExit() {
            if (confirm('سيتم حفظ تقدمك، هل تريد الخروج؟')) {
                renderSections();
                showScreen('sectionsScreen');
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showAlert(message) {
            const alert = document.createElement('div');
            alert.className = 'alert';
            alert.innerHTML = message;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        window.onload = function() {
            renderImamsGrid();
            loadAllQuestions();
        };
    </script>
</body>
</html>
